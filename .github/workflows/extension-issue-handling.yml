name: Extension Issue Handling
on:
  issues:
    types: [opened, labeled]

jobs:
  handle-extension-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Extensions from Repositories
        id: fetch-extensions
        run: |
          REPOS=(
            "https://raw.githubusercontent.com/ni3x/aniyomi-extensions/repo/index.min.json"
            "https://raw.githubusercontent.com/Kohi-den/extensions/main/index.min.json"
            "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json"
          )

          EXTENSIONS_FILE=extensions.txt
          > $EXTENSIONS_FILE

          for repo in "${REPOS[@]}"; do
            echo "Fetching from $repo"
            curl -sL "$repo" | jq -r '.[].name' | \
            sed -E 's/^(Aniyomi:|Tachiyomi:)//' | \
            tr '[:upper:]' '[:lower:]' | \
            sed -E 's/[^a-z0-9]//g' >> $EXTENSIONS_FILE
          done

          sort -u $EXTENSIONS_FILE -o $EXTENSIONS_FILE

          EXTENSIONS_LIST=$(paste -sd'|' $EXTENSIONS_FILE)
          echo "extensions_list=$EXTENSIONS_LIST" >> $GITHUB_OUTPUT
          echo "Number of Extensions: $(wc -l < $EXTENSIONS_FILE)"  # Added log for number of extensions
          cat $EXTENSIONS_FILE

      - name: Check Issue Content
        if: github.event.action == 'opened'
        id: check-issue
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          EXTENSIONS: ${{ steps.fetch-extensions.outputs.extensions_list }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]//g')
          CLEAN_BODY=$(echo "$ISSUE_BODY" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]//g')

          echo "Cleaned Title: $CLEAN_TITLE"
          echo "Cleaned Body: $CLEAN_BODY"

          EXTENSIONS_FILE=extensions.txt
          IS_EXTENSION_ISSUE=false
          MATCHED_EXTENSION=""

          while IFS= read -r ext; do
            if [[ "$CLEAN_TITLE" == *"$ext"* ]]; then
              IS_EXTENSION_ISSUE=true
              MATCHED_EXTENSION="$ext"
              break
            fi
          done < "$EXTENSIONS_FILE"

          if [ "$IS_EXTENSION_ISSUE" = false ] && [ -n "$CLEAN_BODY" ]; then
            while IFS= read -r ext; do
              if [[ "$CLEAN_BODY" == *"$ext"* ]]; then
                IS_EXTENSION_ISSUE=true
                MATCHED_EXTENSION="$ext"
                break
              fi
            done < "$EXTENSIONS_FILE"
          fi

          echo "Is Extension Issue: $IS_EXTENSION_ISSUE"
          echo "Matched Extension: $MATCHED_EXTENSION"

          if [ "$IS_EXTENSION_ISSUE" = true ]; then
            echo "is_extension_issue=true" >> $GITHUB_OUTPUT
            echo "detected_extension=$MATCHED_EXTENSION" >> $GITHUB_OUTPUT
          else
            echo "is_extension_issue=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment and Close Extension Issue
        if: steps.check-issue.outputs.is_extension_issue == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const reportedExtension = "${{ steps.check-issue.outputs.detected_extension || 'Unknown Extension' }}";

            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            for (const label of currentLabels.data) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: label.name
              });
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['wontfix']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `# Not Our Business!
                    Dantotsu doesn't maintain extensions.
                    If the extension doesn't work, we cannot help you.
                    Contact the owner of the respective repository for extension-related problems.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
